<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance | Enactus FTU Hanoi</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
 * {
  box-sizing: border-box;
}
body {
  font-family: 'Montserrat', sans-serif;
  background: #fdfdfd;
  margin: 0;
  padding: 0 20px 40px;
  color: #333;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}
header {
  width: 100%;
  max-width: 1000px;
  padding: 30px 0;
  text-align: center;
  border-bottom: 2px solid #ffc107;
  margin-bottom: 40px;
}
header h1 {
  margin: 0;
  font-size: 28px;
  color: #222;
  font-weight: 700;
}
main {
  width: 100%;
  max-width: 1000px;
  background: #fff;
  padding: 30px 40px;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
}
h2 {
  color: #222;
  font-size: 22px;
  margin-bottom: 15px;
}
form {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 30px;
  align-items: center;
}
input[type="text"],
input[type="datetime-local"] {
  padding: 10px 14px;
  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  flex-grow: 1;
  min-width: 200px;
}
button {
  cursor: pointer;
  background-color: #ffc107;
  border: none;
  color: #222;
  padding: 10px 18px;
  border-radius: 8px;
  font-weight: 600;
  transition: background-color 0.3s ease;
}
button:hover:not(:disabled) {
  background-color: #e6ac00;
}
button:disabled {
  opacity: 0.5;
  cursor: default;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  padding: 12px 14px;
  border-bottom: 1px solid #e0e0e0;
  text-align: center;
  font-size: 14px;
}
th {
  background-color: #ffc107;
  color: #222;
  font-weight: 700;
}
td {
  background-color: #fff;
}

.btn-small {
  padding: 6px 12px;
  font-size: 13px;
  border-radius: 6px;
  background-color: #555;
  color: white;
  border: none;
  margin: 2px;
}
.btn-small:hover {
  background-color: #333;
}

.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.modal {
  background: white;
  padding: 25px 30px;
  border-radius: 16px;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  position: relative;
}
.modal h3 {
  margin-top: 0;
  font-size: 20px;
  font-weight: 700;
}
.modal button.close-btn {
  position: absolute;
  top: 10px;
  right: 12px;
  background: transparent;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}

.attendance-list {
  margin-top: 15px;
  text-align: left;
  max-height: 60vh;
  overflow-y: auto;
}
.attendance-list table {
  width: 100%;
  border-collapse: collapse;
}
.attendance-list th {
  background-color: #ffc107;
  color: #222;
  font-weight: 700;
}
.attendance-list th, .attendance-list td {
  padding: 8px 10px;
  border-bottom: 1px solid #ddd;
  text-align: left;
  font-size: 14px;
}

.qr-code {
  margin-top: 10px;
  display: inline-block;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.qr-code:hover {
  transform: scale(1.1);
}
  </style>
</head>
<body>

<header>
  <h1>ATTENDANCE | ENACTUS FTU HANOI</h1>
</header>

<main id="admin-panel">
  <form id="createSessionForm">
    <input type="text" id="sessionName" placeholder="T√™n phi√™n ƒëi·ªÉm danh (b·∫Øt bu·ªôc)" required />
    <input type="datetime-local" id="startTime" required />
    <input type="datetime-local" id="endTime" required />
    <button type="submit">T·∫°o phi√™n ƒëi·ªÉm danh m·ªõi</button>
  </form>

  <h2>Danh s√°ch phi√™n ƒëi·ªÉm danh</h2>
  <table id="sessionsTable" aria-label="Danh s√°ch phi√™n ƒëi·ªÉm danh">
    <thead>
      <tr>
        <th>STT</th>
        <th>T√™n phi√™n</th>
        <th>Th·ªùi gian b·∫Øt ƒë·∫ßu</th>
        <th>Th·ªùi gian k·∫øt th√∫c</th>
        <th>QR Code</th>
        <th>Ng∆∞·ªùi ƒëi·ªÉm danh</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody id="sessionsTbody"></tbody>
  </table>
</main>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR Code -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
  // ==== C·∫§U H√åNH FIREBASE ==== //
  const firebaseConfig = {
    apiKey: "AIzaSyDuTvBn8Xl01DYddVXQ7M0L24K3l-GyG0c",
    authDomain: "enactusftuhanoi-tracuu.firebaseapp.com",
    projectId: "enactusftuhanoi-tracuu",
    storageBucket: "enactusftuhanoi-tracuu.appspot.com",
    messagingSenderId: "611356979403",
    appId: "1:611356979403:web:2c9a4cffb2b323ce3deb4e"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ==== KI·ªÇM TRA QUY·ªÄN TRUY C·∫¨P ==== //
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "/login.html";
      return;
    }

    const userEmail = user.email;
    if (!userEmail) {
      alert("T√†i kho·∫£n kh√¥ng c√≥ email, kh√¥ng th·ªÉ x√°c minh.");
      window.location.href = "/login.html";
      return;
    }

    try {
      const snapshot = await db.collection("employees")
        .where("email", "==", userEmail)
        .get();

      if (snapshot.empty) {
        alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng.");
        window.location.href = "/login.html";
        return;
      }

      const userData = snapshot.docs[0].data();
      if (userData.role !== "Admin") {
        alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.");
        window.location.href = "/login.html";
        return;
      }

      // N·∫øu l√† Admin => ti·∫øp t·ª•c t·∫£i n·ªôi dung
      loadSessions();

    } catch (error) {
      console.error("L·ªói x√°c th·ª±c:", error);
      alert("ƒê√£ x·∫£y ra l·ªói khi x√°c th·ª±c quy·ªÅn truy c·∫≠p.");
      window.location.href = "/login.html";
    }
  });

  const createSessionForm = document.getElementById('createSessionForm');
  const sessionsTbody = document.getElementById('sessionsTbody');

  // ==== T·∫†O PHI√äN M·ªöI ==== //
  createSessionForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('sessionName').value.trim();
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!name || !startTime || !endTime) {
      alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
      return;
    }
    if (new Date(endTime) <= new Date(startTime)) {
      alert('Th·ªùi gian k·∫øt th√∫c ph·∫£i l·ªõn h∆°n th·ªùi gian b·∫Øt ƒë·∫ßu!');
      return;
    }

    try {
      await db.collection('attendanceSessions').add({
        name,
        startTime: firebase.firestore.Timestamp.fromDate(new Date(startTime)),
        endTime: firebase.firestore.Timestamp.fromDate(new Date(endTime)),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('T·∫°o phi√™n ƒëi·ªÉm danh th√†nh c√¥ng!');
      createSessionForm.reset();
      loadSessions();
    } catch (error) {
      console.error('L·ªói t·∫°o phi√™n:', error);
      alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.');
    }
  });

  // ==== HI·ªÇN TH·ªä DANH S√ÅCH ==== //
  async function loadSessions() {
    sessionsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
    try {
      const snapshot = await db.collection('attendanceSessions')
        .orderBy('createdAt', 'desc')
        .get();

      if (snapshot.empty) {
        sessionsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Ch∆∞a c√≥ phi√™n ƒëi·ªÉm danh n√†o.</td></tr>';
        return;
      }

      let idx = 1;
      sessionsTbody.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const id = doc.id;
        const isLocked = data.locked === true;

        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${idx++}</td>
          <td>${data.name}${isLocked ? ' üîí' : ''}</td>
          <td>${data.startTime?.toDate().toLocaleString() || '-'}</td>
          <td>${data.endTime?.toDate().toLocaleString() || '-'}</td>
        `;

        const tdQR = document.createElement('td');
        const qrBtn = document.createElement('button');
        qrBtn.textContent = 'Hi·ªÉn th·ªã QR';
        qrBtn.className = 'btn-small';
        qrBtn.disabled = isLocked;
        qrBtn.onclick = () => showQRCode(id);
        tdQR.appendChild(qrBtn);

        const tdView = document.createElement('td');
        const viewBtn = document.createElement('button');
        viewBtn.textContent = 'Xem ng∆∞·ªùi ƒëi·ªÉm danh';
        viewBtn.className = 'btn-small';
        viewBtn.onclick = () => showAttendanceList(id);
        tdView.appendChild(viewBtn);

        const tdActions = document.createElement('td');
        tdActions.innerHTML = `
          <button class="btn-small" ${isLocked ? 'disabled' : ''} onclick="editSession('${id}', ${JSON.stringify(data)})">Ch·ªânh s·ª≠a</button>
          <button class="btn-small" onclick="toggleLockSession('${id}', ${isLocked})">${isLocked ? 'M·ªü kh√≥a' : 'Kh√≥a'}</button>
          <button class="btn-small" ${isLocked ? 'disabled' : ''} onclick="deleteSession('${id}')">X√≥a</button>
        `;

        tr.append(tdQR, tdView, tdActions);
        sessionsTbody.appendChild(tr);
      });

    } catch (error) {
      sessionsTbody.innerHTML = `<tr><td colspan="7" style="color:red;">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</td></tr>`;
    }
  }

  // ==== QR CODE ==== //
  function showQRCode(sessionId) {
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <button class="close-btn">&times;</button>
      <h3>QR Code cho phi√™n ƒëi·ªÉm danh</h3>
    `;

    const canvas = document.createElement('canvas');
    canvas.style.marginTop = '15px';
    modal.appendChild(canvas);

    modal.querySelector('.close-btn').onclick = () => document.body.removeChild(modalOverlay);
    modalOverlay.appendChild(modal);
    document.body.appendChild(modalOverlay);

    QRCode.toCanvas(canvas, sessionId, { width: 220 }, (error) => {
      if (error) console.error(error);
    });
  }

  // ==== XEM NG∆Ø·ªúI ƒêI·ªÇM DANH ==== //
  async function showAttendanceList(sessionId) {
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <button class="close-btn">&times;</button>
      <h3>Danh s√°ch ng∆∞·ªùi ƒëi·ªÉm danh</h3>
    `;
    const listDiv = document.createElement('div');
    listDiv.className = 'attendance-list';
    listDiv.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';
    modal.appendChild(listDiv);

    modal.querySelector('.close-btn').onclick = () => document.body.removeChild(modalOverlay);
    modalOverlay.appendChild(modal);
    document.body.appendChild(modalOverlay);

    try {
      const snapshot = await db.collection('attendanceSessions')
        .doc(sessionId)
        .collection('attendees')
        .get();

      if (snapshot.empty) {
        listDiv.textContent = 'Ch∆∞a c√≥ ai ƒëi·ªÉm danh.';
        return;
      }

      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr><th>STT</th><th>Th·ªùi gian</th><th>H·ªç t√™n</th><th>Ban</th><th>Email</th></tr>
        </thead><tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');

      let idx = 1;
      snapshot.forEach(doc => {
        const data = doc.data();
        const time = data.checkedInAt?.toDate().toLocaleString() || 'Kh√¥ng r√µ';
        tbody.innerHTML += `
          <tr>
            <td>${idx++}</td>
            <td>${time}</td>
            <td>${data.name || '·∫®n danh'}</td>
            <td>${data.ban || 'Kh√¥ng r√µ'}</td>
            <td>${data.email || doc.id}</td>
          </tr>
        `;
      });

      listDiv.innerHTML = '';
      listDiv.appendChild(table);

    } catch (error) {
      listDiv.textContent = `L·ªói: ${error.message}`;
    }
  }

  // ==== CH·ªàNH S·ª¨A ==== //
  function editSession(sessionId, data) {
    const newName = prompt("Nh·∫≠p t√™n m·ªõi:", data.name);
    if (newName && newName.trim() !== "") {
      db.collection('attendanceSessions').doc(sessionId).update({ name: newName.trim() })
        .then(() => {
          alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
          loadSessions();
        })
        .catch(err => {
          alert("L·ªói c·∫≠p nh·∫≠t: " + err.message);
        });
    }
  }

  // ==== KH√ìA / M·ªû KH√ìA ==== //
  function toggleLockSession(sessionId, isLocked) {
    db.collection('attendanceSessions').doc(sessionId).update({ locked: !isLocked })
      .then(() => {
        alert(isLocked ? "M·ªü kh√≥a th√†nh c√¥ng!" : "Kh√≥a th√†nh c√¥ng!");
        loadSessions();
      })
      .catch(err => alert("L·ªói: " + err.message));
  }

  // ==== X√ìA ==== //
  function deleteSession(sessionId) {
    if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) {
      db.collection('attendanceSessions').doc(sessionId).delete()
        .then(() => {
          alert("ƒê√£ x√≥a!");
          loadSessions();
        })
        .catch(err => alert("L·ªói: " + err.message));
    }
  }

</script>
</body>
</html>
