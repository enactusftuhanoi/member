<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Badge | Enactus FTU Hanoi</title>
  <link href="/icon.png" rel="icon" type="image/png"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Montserrat', sans-serif;
    background: linear-gradient(to bottom right, #fffbea, #f9f9f9);
    margin: 0;
    padding: 40px 20px;
    color: #333;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    padding: 40px;
  }

  h2 {
    text-align: center;
    color: #333;
    font-weight: 700;
    margin-bottom: 30px;
  }

  .btn {
    border-radius: 12px !important;
    padding: 10px 20px;
    font-size: 15px;
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    margin-top: 20px;
    font-size: 15px;
  }

  thead th {
    color: #444;
    font-weight: 700;
    text-align: left;
    padding: 12px 16px;
    background-color: #fdf4c5;
    border-radius: 10px 10px 0 0;
  }

  tbody tr {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  tbody tr:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 194, 34, 0.2);
  }

  tbody td {
    padding: 12px 16px;
    vertical-align: middle;
  }

  tbody td:last-child {
    display: flex;
    gap: 8px;
  }

  tbody button {
    background: #1a73e8;
    padding: 8px 14px;
    font-size: 14px;
    border-radius: 10px;
    color: white;
    border: none;
  }

  tbody button.delete-btn {
    background: #e53935;
  }

  .badge-icon {
    width: 40px;
    height: 40px;
    object-fit: contain;
    border-radius: 8px;
    border: 1px solid #eee;
    background-color: #f5f5f5;
    padding: 4px;
  }

  .modal-content {
    border-radius: 16px;
    padding: 10px;
  }

  .form-label {
    font-weight: 600;
  }

  .form-control, .form-select {
    border-radius: 10px;
    padding: 10px;
    font-size: 14px;
  }

  .modal-footer .btn {
    min-width: 120px;
  }

  @media (max-width: 768px) {
    .container {
      padding: 20px;
    }

    .btn {
      width: 100%;
      margin-bottom: 10px;
    }

    .d-flex {
      flex-direction: column !important;
      align-items: stretch !important;
    }
  }
</style>
</head>
<body class="p-4 bg-light">

  <div class="container" id="adminPage">
    <h2 class="mb-4">üéñÔ∏è Danh s√°ch Huy hi·ªáu</h2>

    <div class="d-flex justify-content-end mb-3">
      <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createBadgeModal">+ T·∫°o huy hi·ªáu m·ªõi</button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignBadgeModal">üéÅ G·∫Øn huy hi·ªáu</button>
    </div>

    <table class="table table-bordered table-hover bg-white">
      <thead class="table-light">
        <tr>
          <th>Icon</th>
          <th>T√™n huy hi·ªáu</th>
          <th>Lo·∫°i</th>
          <th>S·ª± ki·ªán/D·ª± √°n</th>
          <th>S·ªë ng∆∞·ªùi ƒë·∫°t</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="badge-table-body">
        <tr><td colspan="6">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Modal t·∫°o huy hi·ªáu -->
  <div class="modal fade" id="createBadgeModal" tabindex="-1" aria-labelledby="createBadgeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="createBadgeForm">
          <div class="modal-header">
            <h5 class="modal-title" id="createBadgeModalLabel">T·∫°o huy hi·ªáu m·ªõi</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">T√™n huy hi·ªáu</label>
                <input type="text" class="form-control" id="badgeTitle" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Lo·∫°i</label>
                <select class="form-select" id="badgeType">
                  <option value="event">S·ª± ki·ªán</option>
                  <option value="project">D·ª± √°n</option>
                  <option value="milestone">C·ªôt m·ªëc</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">M√¥ t·∫£</label>
                <textarea class="form-control" id="badgeDescription" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Icon URL</label>
                <input type="text" class="form-control" id="badgeIconUrl">
              </div>
              <div class="col-md-6">
                <label class="form-label">ID s·ª± ki·ªán (n·∫øu c√≥)</label>
                <input type="text" class="form-control" id="badgeEventId">
              </div>
              <div class="col-md-12">
                <label class="form-label">ƒêi·ªÅu ki·ªán (n·∫øu l√† milestone)</label>
                <input type="text" class="form-control" id="badgeMilestoneCondition">
              </div>
              <div class="col-md-6">
                <label class="form-label">Hi·ªÉn th·ªã c√¥ng khai?</label>
                <select class="form-select" id="badgeIsPublic">
                  <option value="true">C√≥</option>
                  <option value="false">Kh√¥ng</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">L∆∞u huy hi·ªáu</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hu·ª∑</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal g·∫Øn huy hi·ªáu -->
  <div class="modal fade" id="assignBadgeModal" tabindex="-1" aria-labelledby="assignBadgeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="assignBadgeForm">
          <div class="modal-header">
            <h5 class="modal-title" id="assignBadgeModalLabel">G·∫Øn huy hi·ªáu cho th√†nh vi√™n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Nh·∫≠p email th√†nh vi√™n (c√°ch nhau b·ªüi d·∫•u `;`)</label>
              <textarea class="form-control" id="badgeEmails" rows="2" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Ch·ªçn huy hi·ªáu ƒë·ªÉ g·∫Øn</label>
              <select class="form-select" id="badgeSelect" required>
                <option value="">-- Ch·ªçn huy hi·ªáu --</option>
              </select>
            </div>
            <div id="emailValidationResults" class="small text-muted mt-2"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">G·∫Øn huy hi·ªáu</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hu·ª∑</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal xem huy hi·ªáu -->
  <div class="modal fade" id="viewBadgeModal" tabindex="-1" aria-labelledby="viewBadgeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewBadgeModalLabel">Chi ti·∫øt huy hi·ªáu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
        </div>
        <div class="modal-body">
          <!-- Render b·∫±ng JS -->
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc,
  getDoc, setDoc, query, where
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  // ==== KH·ªûI T·∫†O FIREBASE ==== //

    const firebaseConfig = {
      apiKey: "AIzaSyDuTvBn8Xl01DYddVXQ7M0L24K3l-GyG0c",
      authDomain: "enactusftuhanoi-tracuu.firebaseapp.com",
      projectId: "enactusftuhanoi-tracuu",
      storageBucket: "enactusftuhanoi-tracuu.appspot.com",
      messagingSenderId: "611356979403",
      appId: "1:611356979403:web:2c9a4cffb2b323ce3deb4e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Auth + ph√¢n quy·ªÅn admin
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "/login.html?redirect=" + encodeURIComponent(window.location.pathname);

        return;
      }

      const userEmail = user.email;
      if (!userEmail) {
        alert("T√†i kho·∫£n ch∆∞a c√≥ email, kh√¥ng th·ªÉ x√°c th·ª±c quy·ªÅn admin.");
        await auth.signOut();
        window.location.href = "/login.html?redirect=" + encodeURIComponent(window.location.pathname);

        return;
      }

      try {
        const q = query(collection(db, "employees"), where("email", "==", userEmail));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng.");
          await auth.signOut();
          window.location.href = "/login.html?redirect=" + encodeURIComponent(window.location.pathname);

          return;
        }

        const userData = snapshot.docs[0].data();
        if (userData.role === "Admin") {
          await loadBadges();
        } else {
          alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.");
          await auth.signOut();
          window.location.href = "/login.html?redirect=" + encodeURIComponent(window.location.pathname);

        }
      } catch (error) {
        console.error("L·ªói khi ki·ªÉm tra quy·ªÅn admin:", error);
        alert("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.");
        await auth.signOut();
        window.location.href = "/login.html?redirect=" + encodeURIComponent(window.location.pathname);

      }
    });

    // C√°c h√†m x·ª≠ l√Ω huy hi·ªáu
    async function loadBadges() {
      const badgeTable = document.querySelector("#badge-table-body");
      badgeTable.innerHTML = "";
      const badgeSnapshots = await getDocs(collection(db, "badges"));
      const userBadgeSnapshots = await getDocs(collection(db, "userbadge"));

      const badgeUserCount = {};
      userBadgeSnapshots.forEach(docSnap => {
        const data = docSnap.data();
        (data.badges || []).forEach(badgeId => {
          if (!badgeUserCount[badgeId]) badgeUserCount[badgeId] = 0;
          badgeUserCount[badgeId]++;
        });
      });

      badgeSnapshots.forEach((doc) => {
        const badge = doc.data();
        const count = badgeUserCount[doc.id] || 0;
        const row = `
          <tr>
            <td><img src="${badge.iconUrl}" class="badge-icon" alt="${badge.title}"></td>
            <td>${badge.title}</td>
            <td>${badge.type}</td>
            <td>${badge.eventId || "-"}</td>
            <td>${count}</td>
            <td>
              <button class="btn btn-sm btn-info" onclick="viewBadge('${doc.id}')">Xem</button>
              <button class="btn btn-sm btn-primary" onclick="editBadge('${doc.id}')">S·ª≠a</button>
              <button class="btn btn-sm btn-danger" onclick="deleteBadge('${doc.id}')">Xo√°</button>
            </td>
          </tr>`;
        badgeTable.innerHTML += row;
      });
    }

    async function loadBadgeOptions() {
      const badgeSelect = document.getElementById("badgeSelect");
      badgeSelect.innerHTML = `<option value="">-- Ch·ªçn huy hi·ªáu --</option>`;
      const querySnapshot = await getDocs(collection(db, "badges"));
      querySnapshot.forEach((docSnap) => {
        const badge = docSnap.data();
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = badge.title;
        badgeSelect.appendChild(option);
      });
    }

    document.getElementById("assignBadgeModal").addEventListener("show.bs.modal", loadBadgeOptions);

    document.getElementById("assignBadgeForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const rawEmails = document.getElementById("badgeEmails").value;
      const badgeId = document.getElementById("badgeSelect").value;
      const resultDiv = document.getElementById("emailValidationResults");
      resultDiv.innerHTML = "üîÑ ƒêang ki·ªÉm tra email...";

      const emails = rawEmails.split(";").map(email => email.trim()).filter(e => e);
      const validUsers = [];
      const invalidEmails = [];

      for (const email of emails) {
        const q = query(collection(db, "employees"), where("email", "==", email));
        const snapshot = await getDocs(q);
        if (!snapshot.empty) {
          validUsers.push(email);
        } else {
          invalidEmails.push(email);
        }
      }

      if (invalidEmails.length > 0) {
        resultDiv.innerHTML = `‚ùå Kh√¥ng t√¨m th·∫•y: ${invalidEmails.join(", ")}`;
        return;
      }

      for (const email of validUsers) {
        const userBadgeRef = doc(db, "userbadge", email);
        const userBadgeSnap = await getDoc(userBadgeRef);
        const existing = userBadgeSnap.exists() ? userBadgeSnap.data().badges || [] : [];
        const updatedBadges = [...new Set([...existing, badgeId])];
        await setDoc(userBadgeRef, { badges: updatedBadges }, { merge: true });
      }

      resultDiv.innerHTML = `‚úÖ G·∫Øn huy hi·ªáu th√†nh c√¥ng cho: ${validUsers.join(", ")}`;
      document.getElementById("assignBadgeForm").reset();
      loadBadges();
    });

    async function editBadge(id) {
      const docRef = doc(db, "badges", id);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return alert("Badge kh√¥ng t·ªìn t·∫°i!");

      const badge = docSnap.data();
      document.querySelector("#badgeTitle").value = badge.title;
      document.querySelector("#badgeType").value = badge.type;
      document.querySelector("#badgeDescription").value = badge.description;
      document.querySelector("#badgeIconUrl").value = badge.iconUrl;
      document.querySelector("#badgeEventId").value = badge.eventId || "";
      document.querySelector("#badgeMilestoneCondition").value = badge.milestoneCondition || "";
      document.querySelector("#badgeIsPublic").value = badge.isPublic ? "true" : "false";

      const form = document.querySelector("#createBadgeForm");
      form.replaceWith(form.cloneNode(true));
      const newForm = document.querySelector("#createBadgeForm");

      newForm.addEventListener("submit", async function handler(e) {
        e.preventDefault();
        await updateDoc(docRef, {
          title: document.querySelector("#badgeTitle").value,
          type: document.querySelector("#badgeType").value,
          description: document.querySelector("#badgeDescription").value,
          iconUrl: document.querySelector("#badgeIconUrl").value,
          eventId: document.querySelector("#badgeEventId").value,
          milestoneCondition: document.querySelector("#badgeMilestoneCondition").value,
          isPublic: document.querySelector("#badgeIsPublic").value === "true"
        });
        const modal = bootstrap.Modal.getInstance(document.getElementById("createBadgeModal"));
        modal.hide();
        loadBadges();
      });

      new bootstrap.Modal(document.getElementById("createBadgeModal")).show();
    }

    async function viewBadge(id) {
      const badgeRef = doc(db, "badges", id);
      const badgeSnap = await getDoc(badgeRef);
      if (!badgeSnap.exists()) return alert("Kh√¥ng t√¨m th·∫•y huy hi·ªáu");

      const badge = badgeSnap.data();
      let html = `
        <h5>${badge.title}</h5>
        <p>${badge.description || ""}</p>
        <p><strong>Lo·∫°i:</strong> ${badge.type}</p>
        <hr>
        <h6>Danh s√°ch th√†nh vi√™n ƒë·∫°t:</h6>
        <table class="table table-sm">
          <thead><tr><th>#</th><th>H·ªç v√† t√™n</th><th>Ban</th></tr></thead>
          <tbody>`;

      const querySnapshot = await getDocs(collection(db, "userbadge"));
      let index = 1;
      for (const docSnap of querySnapshot.docs) {
        const badges = docSnap.data().badges || [];
        if (badges.includes(id)) {
          const email = docSnap.id;
          const q = query(collection(db, "employees"), where("email", "==", email));
          const empSnap = await getDocs(q);
          if (!empSnap.empty) {
            const emp = empSnap.docs[0].data();
            html += `<tr><td>${index++}</td><td>${emp.name || "-"}</td><td>${emp.ban || "-"}</td></tr>`;
          }
        }
      }

      html += "</tbody></table>";
      const modalBody = document.querySelector("#viewBadgeModal .modal-body");
      modalBody.innerHTML = html;
      new bootstrap.Modal(document.getElementById("viewBadgeModal")).show();
    }

    async function deleteBadge(id) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° huy hi·ªáu n√†y kh√¥ng?")) return;
      await deleteDoc(doc(db, "badges", id));
      loadBadges();
    }

    window.editBadge = editBadge;
    window.viewBadge = viewBadge;
    window.deleteBadge = deleteBadge;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
